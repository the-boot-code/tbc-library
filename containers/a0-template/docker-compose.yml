# Extension fields for common values
x-common-config: &common-config
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "1m"
      max-file: "10"

services:
  # Main service for Agent instance
  a0:
    <<: *common-config
    container_name: ${CONTAINER_NAME}
    image: ${IMAGE_NAME}
    
    working_dir: /a0/work_dir

    volumes:

      # Containers
      - ${PATH_CONTAINERS}:/containers:rw

      # Layers
      - ${PATH_LAYERS}:/layers:rw

      # Composition
      - ${AGENT_ORCHESTRATION}:/agent_orchestration:ro
      - ${AGENT_CONTAINER}:/agent_container:rw
      - ${AGENT_LAYER}:/agent_layer:rw
      - ${COMMON_LAYER}:/common_layer:ro
      - ${CONTROL_LAYER}:/control_layer:ro

      # control_layer
      - ${CONTROL_LAYER}:/a0/control_layer:ro

      # Agent Zero
      - ${AGENT_CONTAINER}:/a0

      # Un-Comment the following to mount the Agent Zero `/a0/.env` file to container. This file **MUST** exist at `/layers/[container_name]/.env` prior to running docker compose otherwise an empty directory will instead be created by the same name causing a failure as well as a subsequent conflict.
      # - ${AGENT_LAYER}/.env:/a0/.env:rw

      # root
      - ${AGENT_LAYER}/root:/root

      # Volumes
      - ${PATH_VOLUMES}:/volumes:ro
      - ${PATH_SHARED}:/shared
      - ${PATH_COMMON}:/common
      - ${PATH_PRIVATE}/${CONTAINER_NAME}:/private/${CONTAINER_NAME}:rw
      - ${PATH_PUBLIC}:/public

      # memory
      - ${AGENT_LAYER}/memory:/a0/memory

      # agents
      - ${AGENT_LAYER}/agents/${CONTAINER_NAME}:/a0/agents/${CONTAINER_NAME}
      - ${COMMON_LAYER}/agents/kairos:/a0/agents/kairos:ro
      - ${COMMON_LAYER}/agents/_symlink:/a0/agents/_symlink:ro

      # conf
      - ${AGENT_LAYER}/conf:/a0/conf

      # logs
      - ${AGENT_LAYER}/logs:/a0/logs

      # tmp
      - ${AGENT_LAYER}/tmp:/a0/tmp

      # work_dir
      - ${AGENT_LAYER}/work_dir:/a0/work_dir

      # instruments
      - ${COMMON_LAYER}/instruments/${KNOWLEDGE_DIR}:/a0/instruments/${KNOWLEDGE_DIR}:rw
      - ${COMMON_LAYER}/instruments/default/main/common:/a0/instruments/default/main/common:rw
      # - ${AGENT_LAYER}/instruments/default/main/container:/a0/instruments/default/main/container:rw
      - ../../create_agent.md:/a0/instruments/default/main/tbc-library/create_agent.md:ro
      - ../../create_agent.sh:/a0/instruments/default/main/tbc-library/create_agent.sh:ro

      # knowledge
      - ${COMMON_LAYER}/knowledge/${KNOWLEDGE_DIR}:/a0/knowledge/${KNOWLEDGE_DIR}:rw
      - ${COMMON_LAYER}/knowledge/default/main/common:/a0/knowledge/default/main/common:rw
      - ${COMMON_LAYER}/knowledge/default/solutions/common:/a0/knowledge/default/solutions/common:rw
      # - ${AGENT_LAYER}/knowledge/default/main/container:/a0/knowledge/default/main/container:rw
      # - ${AGENT_LAYER}/knowledge/default/solutions/container:/a0/knowledge/default/solutions/container:rw
      # - ../../README.md:/a0/knowledge/default/main/tbc-library/README.md:ro
      - ${COMMON_LAYER}/knowledge/default/main/tbc-library:/a0/knowledge/default/main/tbc-library:ro
      - ${COMMON_LAYER}/knowledge/default/solutions/tbc-library:/a0/knowledge/default/solutions/tbc-library:ro

      # prompts
      - ${COMMON_LAYER}/prompts/${KNOWLEDGE_DIR}:/a0/prompts/${KNOWLEDGE_DIR}:rw
      - ${COMMON_LAYER}/prompts/system:/a0/prompts/system:ro
      # - ${AGENT_LAYER}/prompts/container:/a0/prompts/container

      # usr
      - ${COMMON_LAYER}/usr:/a0/usr:rw

      # python
      # - ${COMMON_LAYER}/python/helpers/kokoro_tts.py:/a0/python/helpers/kokoro_tts.py:ro
      # - ${COMMON_LAYER}/python/helpers/files.py:/a0/python/helpers/files.py:ro
      
      # Configuration files (read-only)
      # - ./pip.conf:/etc/pip.conf:ro
      # - ./pip-constraints.txt:/etc/pip-constraints.txt:ro

    ports:
      - "${HOST_PORT_SSH}:${CONTAINER_PORT_SSH}"
      - "${HOST_PORT_HTTP}:${CONTAINER_PORT_HTTP}"
      - "${HOST_PORT_SPARE_1}:${CONTAINER_PORT_SPARE_1}"
      - "${HOST_PORT_SPARE_2}:${CONTAINER_PORT_SPARE_2}"
      - "${HOST_PORT_SPARE_3}:${CONTAINER_PORT_SPARE_3}"

    deploy:
      resources:
        reservations:
          cpus: ${CPU_RESERVED}
          memory: ${MEMORY_RESERVED}
        # limits:
          # cpus: ${CPU_LIMIT}
          # memory: ${MEMORY_LIMIT}
    # memswap_limit: ${MEMORY_SWAP_LIMIT}

  # Nginx reverse proxy with SSL
  nginx:
    <<: *common-config
    image: nginx:alpine
    container_name: ${CONTAINER_NAME}-nginx
    
    ports:
      - "${NGINX_PORT_HTTPS}:${NGINX_CONTAINER_PORT_HTTPS}"
    
    env_file:
      - .env
    
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf.template:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    
    entrypoint: 
      - /bin/sh
      - -c
      - envsubst '$$NGINX_CONTAINER_PORT_HTTP $$NGINX_CONTAINER_PORT_HTTPS $$CONTAINER_NAME' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'
    
    depends_on:
      - a0
    
    networks:
      - default

networks:
  default:
    driver: bridge
