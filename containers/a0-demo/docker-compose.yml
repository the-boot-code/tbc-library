# Extension fields for common values
x-common-config: &common-config
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "1m"
      max-file: "10"

services:
  # Main service for Agent instance
  a0:
    <<: *common-config
    container_name: ${CONTAINER_NAME}
    image: ${IMAGE_NAME}
    
    working_dir: /a0/work_dir

    volumes:

      # Containers
      - ${PATH_CONTAINERS}:/containers:ro
      - ${PATH_CONTAINER}:/container:ro

      # Layers
      - ${PATH_LAYERS}:/layers:ro
      - ${CONTAINER_LAYER}:/container_layer:ro
      - ${COMMON_LAYER}:/common_layer:ro

      # Agent Zero
      - ${PATH_CONTAINER}/a0:/a0

      # Un-Comment the following to mount .env to container. However, this file must exist prior to compose or else the result will be docker compose creating an empty directory by the same name thus causing a failure as well as a subsequent conflict.
      # - ${CONTAINER_LAYER}/.env:/a0/.env:rw

      # root
      - ${CONTAINER_LAYER}/root:/root

      # Volumes
      - ${PATH_VOLUMES}:/volumes:ro
      - ${PATH_SHARED}:/shared
      - ${PATH_COMMON}:/common
      - ${PATH_PRIVATE}/${CONTAINER_NAME}:/private/${CONTAINER_NAME}:ro
      - ${PATH_PUBLIC}:/public

      # memory
      - ${CONTAINER_LAYER}/memory:/a0/memory

      # agents
      - ${CONTAINER_LAYER}/agents/${CONTAINER_NAME}:/a0/agents/${CONTAINER_NAME}
      - ${COMMON_LAYER}/agents/kairos:/a0/agents/kairos:ro
      - ${COMMON_LAYER}/agents/_symlink:/a0/agents/_symlink:ro

      # conf
      - ${CONTAINER_LAYER}/conf:/a0/conf

      # logs
      - ${CONTAINER_LAYER}/logs:/a0/logs

      # tmp
      - ${CONTAINER_LAYER}/tmp:/a0/tmp

      # work_dir
      - ${CONTAINER_LAYER}/work_dir:/a0/work_dir

      # instruments
      - ${COMMON_LAYER}/instruments/${KNOWLEDGE_DIR}:/a0/instruments/${KNOWLEDGE_DIR}:ro
      - ${COMMON_LAYER}/instruments/default/main/common:/a0/instruments/default/main/common:ro
      - ${CONTAINER_LAYER}/instruments/default/main/container:/a0/instruments/default/main/container

      # knowledge
      - ${COMMON_LAYER}/knowledge/${KNOWLEDGE_DIR}:/a0/knowledge/${KNOWLEDGE_DIR}:ro
      - ${COMMON_LAYER}/knowledge/default/main/common:/a0/knowledge/default/main/common:ro
      - ${COMMON_LAYER}/knowledge/default/solutions/common:/a0/knowledge/default/solutions/common:ro
      - ${CONTAINER_LAYER}/knowledge/default/main/container:/a0/knowledge/default/main/container
      - ${CONTAINER_LAYER}/knowledge/default/solutions/container:/a0/knowledge/default/solutions/container

      # prompts
      - ${COMMON_LAYER}/prompts/${KNOWLEDGE_DIR}:/a0/prompts/${KNOWLEDGE_DIR}:ro
      # - ${COMMON_LAYER}/prompts/common:/a0/prompts/common:ro
      # - ${COMMON_LAYER}/prompts/default:/a0/prompts/default:ro
      - ${COMMON_LAYER}/prompts/overrides:/a0/prompts/overrides:ro
      - ${COMMON_LAYER}/prompts/system:/a0/prompts/system:ro
      - ${CONTAINER_LAYER}/prompts/container:/a0/prompts/container

      # python
      - ${COMMON_LAYER}/python/helpers/kokoro_tts.py:/a0/python/helpers/kokoro_tts.py:ro
      - ${COMMON_LAYER}/python/helpers/files.py:/a0/python/helpers/files.py:ro
      - ${COMMON_LAYER}/python/helpers/system_control.py:/a0/python/helpers/system_control.py:ro
      
      # Configuration files (read-only)
      # - ./pip.conf:/etc/pip.conf:ro
      # - ./pip-constraints.txt:/etc/pip-constraints.txt:ro

    ports:
      - "${HOST_PORT_SSH}:${CONTAINER_PORT_SSH}"
      - "${HOST_PORT_HTTP}:${CONTAINER_PORT_HTTP}"
      - "${HOST_PORT_SPARE_1}:${CONTAINER_PORT_SPARE_1}"
      - "${HOST_PORT_SPARE_2}:${CONTAINER_PORT_SPARE_2}"
      - "${HOST_PORT_SPARE_3}:${CONTAINER_PORT_SPARE_3}"

    # deploy:
    #   resources:
    #     reservations:
    #       cpus: ${CPU_RESERVED}
    #       memory: ${MEMORY_RESERVED}
    #     limits:
    #       cpus: ${CPU_LIMIT}
    #       memory: ${MEMORY_LIMIT}

  # Nginx reverse proxy with SSL
  nginx:
    <<: *common-config
    image: nginx:alpine
    container_name: ${CONTAINER_NAME}-nginx
    
    ports:
      - "${NGINX_PORT_HTTPS}:${NGINX_CONTAINER_PORT_HTTPS}"
    
    env_file:
      - .env
    
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf.template:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    
    entrypoint: 
      - /bin/sh
      - -c
      - envsubst '$$NGINX_CONTAINER_PORT_HTTP $$NGINX_CONTAINER_PORT_HTTPS $$CONTAINER_NAME' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'
    
    depends_on:
      - a0
    
    networks:
      - default

networks:
  default:
    driver: bridge
